<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heatmap with OSM Vector Tiles</title>
    <script src="{% static 'js/ol.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css/ol.css' %}">
    <script src="{% static 'js/ol-popup.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css/ol-popup.css' %}">
    
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .control-box {
            position: absolute;
            background: rgba(255, 255, 255, 0.85);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            z-index: 1000;
            color: #333;
            font-size: 14px;
        }

        #layer-control {
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
        }

        #layer-control button {
            background: rgba(240, 240, 240, 0.9);
            border: 1px solid #ddd;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #layer-control button:hover {
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .trash-button:hover {
            color: #e74c3c;
        }

        .export-button:hover {
            color: #3498db;
        }

        #osm-control {
            top: 15px;
            left: 15px;
            display: flex;
            gap: 8px;
        }

        #osm-control button {
            background: rgba(240, 240, 240, 0.9);
            border: 1px solid #ddd;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
        }

        #osm-control button:hover {
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #controls {
            bottom: 15px;
            left: 15px;
            min-width: 250px;
        }

        .control-group {
            margin: 8px 0;
            display: flex;
            align-items: center;
        }

        label {
            display: inline-block;
            width: 70px;
            margin-right: 10px;
        }

        input[type="range"] {
            flex-grow: 1;
            margin: 0 10px;
        }

        #coordinates {
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            white-space: nowrap;
        }

        #mouse-coords {
            color: #666;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            width: 400px;
            max-width: 90%;
            overflow: hidden;
        }
        
        .modal-header {
            background: #f5f5f5;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        
        .modal-body {
            padding: 25px 20px;
            font-size: 16px;
            line-height: 1.5;
            color: #555;
        }
        
        .modal-footer {
            padding: 15px 20px;
            background: #f9f9f9;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .cancel-btn {
            background: #f0f0f0;
            color: #333;
        }
        
        .cancel-btn:hover {
            background: #e0e0e0;
        }
        
        .ok-btn {
            background: #e74c3c;
            color: white;
        }
        
        .ok-btn:hover {
            background: #c0392b;
        }
        
        .ol-popup {
            background: rgba(255, 255, 255, 0.85);
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 14px;
            min-width: auto !important;
            max-width: none !important;
            width: auto !important;
            box-sizing: content-box;
            text-align: center;
        }
        
        .ol-popup-closer {
            display: none !important;
        }
        
        .ol-popup-content {
            width: auto !important;
            min-width: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .export-loading, .osm-loading {
            display: flex;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            z-index: 3000;
            font-size: 16px;
            align-items: center;
            gap: 10px;
        }
        
        .export-loading::after, .osm-loading::after {
            content: "";
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <div id="map" class="map"></div>
    <div id="popup"></div>
    
    <div id="confirm-dialog" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
            </div>
            <div class="modal-body">
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.</p>
            </div>
            <div class="modal-footer">
                <button id="confirm-cancel" class="modal-btn cancel-btn">–û—Ç–º–µ–Ω–∞</button>
                <button id="confirm-ok" class="modal-btn ok-btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div id="layer-control" class="control-box">
        <button id="toggle-layers">–°–∫—Ä—ã—Ç—å —Ç–æ—á–∫–∏</button>
        <button id="toggle-osm">–ü–æ–∫–∞–∑–∞—Ç—å OSM</button>
        <button id="clear-db" class="trash-button" title="–û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        </button>
        <button id="export-map" class="export-button" title="–≠–∫—Å–ø–æ—Ä—Ç –∫–∞—Ä—Ç—ã –≤ PNG">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        </button>
    </div>

    <div id="osm-control" class="control-box">
        <button id="draw-osm-rect">üü© –í—ã–±—Ä–∞—Ç—å –æ–±–ª–∞—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ OSM</button>
    </div>

    <div id="controls" class="control-box">
        <div class="control-group">
            <label for="blur">–†–∞–∑–º—ã—Ç–∏–µ:</label>
            <input type="range" id="blur" min="0" max="100" value="45">
            <span id="blur-value">45</span>
        </div>
        <div class="control-group">
            <label for="radius">–†–∞–¥–∏—É—Å:</label>
            <input type="range" id="radius" min="1" max="50" value="8">
            <span id="radius-value">8</span>
        </div>
        <div class="control-group">
            <label for="osm-opacity">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:</label>
            <input type="range" id="osm-opacity" min="0" max="100" value="70">
            <span id="osm-opacity-value">70%</span>
        </div>
        <div id="coordinates">
            –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: <span id="mouse-coords">–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É</span>
        </div>
    </div>

    <script>
        // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map;
        let vectorSource;
        let heatmapLayer;
        let pointLayer;
        let eventSource;
        let lastDataSignature = null;
        let layersVisible = true;
        let resolution;
        let lastRenderTime = 0;
        let popup;
        let dataCheckInterval;
        let osmVectorSource;
        let osmVectorLayer;
        let drawInteraction = null;
        const csrfToken = "{{ csrf_token }}";
        let osmTilesVisible = false;
        let osmVectorTileLayers = [];
        const pgTileservUrl = "http://localhost:7800"; // URL pg_tileserv

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initMap() {
            map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM({
                            url: 'https://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                            attributions: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }),
                        name: 'base_osm'
                    })
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat([20.6531253, 54.6590630]),
                    zoom: 15
                }),
                renderer: 'canvas'
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è popup
            popup = new ol.Overlay.Popup({
                element: document.getElementById('popup'),
                positioning: 'bottom-center',
                stopEvent: false,
                autoPan: false,
                closeBox: false
            });
            map.addOverlay(popup);

            // –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã
            vectorSource = new ol.source.Vector({ wrapX: false });
            
            // –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞
            heatmapLayer = new ol.layer.Heatmap({
                source: vectorSource,
                blur: 45,
                radius: 8,
                weight: 'weight',
                renderMode: 'image',
                name: 'heatmap'
            });

            // –í–µ–∫—Ç–æ—Ä–Ω—ã–π —Å–ª–æ–π —Å —Ç–æ—á–∫–∞–º–∏
            pointLayer = new ol.layer.Vector({
                source: vectorSource,
                style: new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 2,
                        fill: new ol.style.Fill({ color: 'rgba(140, 140, 140, 0.8)' }),
                        stroke: new ol.style.Stroke({
                            color: 'rgba(100, 100, 100, 0.9)',
                            width: 1
                        })
                    })
                }),
                renderMode: 'image',
                name: 'points'
            });

            // –°–ª–æ–π –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–µ–≥–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ OSM
            osmVectorSource = new ol.source.Vector({ wrapX: false });
            osmVectorLayer = new ol.layer.Vector({
                source: osmVectorSource,
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'rgba(255, 0, 0, 0.8)',
                        width: 2
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 0, 0, 0.1)'
                    })
                }),
                name: 'osm_bbox'
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–∏ –Ω–∞ –∫–∞—Ä—Ç—É
            map.addLayer(heatmapLayer);
            map.addLayer(pointLayer);
            map.addLayer(osmVectorLayer);
            
            // –ö–µ—à–∏—Ä—É–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã 
            resolution = map.getView().getResolution();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑—É–º–∞
            map.getView().on('change:resolution', () => {
                resolution = map.getView().getResolution();
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö —Ç–∞–π–ª–æ–≤ OSM —Å–æ —Å—Ç–∏–ª—è–º–∏ –∫–∞–∫ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∫–∞—Ä—Ç–µ
        function addOSMVectorTiles() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª–æ–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            removeOSMVectorTiles();
            
            // –°—Ç–∏–ª–∏ –¥–ª—è –¥–æ—Ä–æ–≥ (–ø–æ —Ç–∏–ø–∞–º)
            const roadStyles = {
                'motorway': {
                    color: '#f9a39f',
                    width: 6,
                    zIndex: 100
                },
                'trunk': {
                    color: '#f9c8a3',
                    width: 5,
                    zIndex: 99
                },
                'primary': {
                    color: '#f9dfa3',
                    width: 4.5,
                    zIndex: 98
                },
                'secondary': {
                    color: '#f9f1a3',
                    width: 4,
                    zIndex: 97
                },
                'tertiary': {
                    color: '#f5f5dc',
                    width: 3.5,
                    zIndex: 96
                },
                'residential': {
                    color: '#ffffff',
                    width: 3,
                    zIndex: 95
                },
                'service': {
                    color: '#f5f5f5',
                    width: 2,
                    zIndex: 94
                },
                'footway': {
                    color: '#e9e9e9',
                    width: 1.5,
                    zIndex: 93
                },
                'path': {
                    color: '#e0e0e0',
                    width: 1.5,
                    zIndex: 92
                }
            };

            // –°—Ç–∏–ª–∏ –¥–ª—è –∂–µ–ª–µ–∑–Ω—ã—Ö –¥–æ—Ä–æ–≥
            const railwayStyle = new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#777',
                    width: 1.5,
                    lineDash: [5, 5]
                }),
                zIndex: 80
            });

            // –°—Ç–∏–ª–∏ –¥–ª—è –≤–æ–¥–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
            const waterStyle = new ol.style.Style({
                fill: new ol.style.Fill({
                    color: '#a5bfdd'
                }),
                stroke: new ol.style.Stroke({
                    color: '#8cacd0',
                    width: 1
                }),
                zIndex: 10
            });

            // –°—Ç–∏–ª–∏ –¥–ª—è –∑–µ–ª–µ–Ω—ã—Ö –∑–æ–Ω
            const greenStyle = new ol.style.Style({
                fill: new ol.style.Fill({
                    color: '#d1e8c9'
                }),
                stroke: new ol.style.Stroke({
                    color: '#b8d8ad',
                    width: 0.5
                }),
                zIndex: 20
            });

            // –°—Ç–∏–ª–∏ –¥–ª—è –∑–¥–∞–Ω–∏–π
            const buildingStyle = new ol.style.Style({
                fill: new ol.style.Fill({
                    color: '#e0dcdc'
                }),
                stroke: new ol.style.Stroke({
                    color: '#c8c4c4',
                    width: 0.7
                }),
                zIndex: 90
            });

            // –°—Ç–∏–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü
            const boundaryStyle = new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#9e9e9e',
                    width: 1.5,
                    lineDash: [4, 4]
                }),
                zIndex: 70
            });

            // –°—Ç–∏–ª–∏ –¥–ª—è —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞ (POI)
            const poiStyle = new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 5,
                    fill: new ol.style.Fill({color: '#4c6ef5'}),
                    stroke: new ol.style.Stroke({
                        color: '#fff',
                        width: 1.5
                    })
                }),
                zIndex: 110
            });

            // –°–æ–∑–¥–∞–µ–º —Å–ª–æ–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤ OSM
            const lineLayer = new ol.layer.VectorTile({
                source: new ol.source.VectorTile({
                    format: new ol.format.MVT(),
                    url: `${pgTileservUrl}/public.planet_osm_line/{z}/{x}/{y}.pbf`,
                    attributions: '¬© OpenStreetMap contributors'
                }),
                style: function(feature) {
                    const tags = feature.getProperties();
                    const highway = tags.highway;
                    
                    // –°—Ç–∏–ª–∏ –¥–ª—è –¥–æ—Ä–æ–≥
                    if (highway && roadStyles[highway]) {
                        const style = roadStyles[highway];
                        return new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: style.color,
                                width: style.width
                            }),
                            zIndex: style.zIndex
                        });
                    }
                    
                    // –°—Ç–∏–ª–∏ –¥–ª—è –∂–µ–ª–µ–∑–Ω—ã—Ö –¥–æ—Ä–æ–≥
                    if (tags.railway) {
                        return railwayStyle;
                    }
                    
                    // –°—Ç–∏–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü
                    if (tags.boundary === 'administrative') {
                        return boundaryStyle;
                    }
                    
                    // –°—Ç–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ª–∏–Ω–∏–π
                    return new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: '#d0d0d0',
                            width: 1
                        }),
                        zIndex: 50
                    });
                },
                name: 'osm_line_tiles',
                className: 'osm-layer'
            });

            const polygonLayer = new ol.layer.VectorTile({
                source: new ol.source.VectorTile({
                    format: new ol.format.MVT(),
                    url: `${pgTileservUrl}/public.planet_osm_polygon/{z}/{x}/{y}.pbf`,
                    attributions: '¬© OpenStreetMap contributors'
                }),
                style: function(feature) {
                    const tags = feature.getProperties();
                    
                    // –°—Ç–∏–ª–∏ –¥–ª—è –≤–æ–¥–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
                    if (tags.natural === 'water' || tags.waterway || tags.water) {
                        return waterStyle;
                    }
                    
                    // –°—Ç–∏–ª–∏ –¥–ª—è –∑–µ–ª–µ–Ω—ã—Ö –∑–æ–Ω
                    if (tags.leisure === 'park' || tags.landuse === 'grass' || 
                        tags.natural === 'wood' || tags.landuse === 'forest') {
                        return greenStyle;
                    }
                    
                    // –°—Ç–∏–ª–∏ –¥–ª—è –∑–¥–∞–Ω–∏–π
                    if (tags.building) {
                        return buildingStyle;
                    }
                    
                    // –°—Ç–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø–æ–ª–∏–≥–æ–Ω–æ–≤
                    return new ol.style.Style({
                        fill: new ol.style.Fill({
                            color: '#f0f0f0'
                        }),
                        stroke: new ol.style.Stroke({
                            color: '#d0d0d0',
                            width: 0.5
                        }),
                        zIndex: 5
                    });
                },
                name: 'osm_polygon_tiles',
                className: 'osm-layer'
            });

            const pointLayer = new ol.layer.VectorTile({
                source: new ol.source.VectorTile({
                    format: new ol.format.MVT(),
                    url: `${pgTileservUrl}/public.planet_osm_point/{z}/{x}/{y}.pbf`,
                    attributions: '¬© OpenStreetMap contributors'
                }),
                style: function(feature) {
                    const tags = feature.getProperties();
                    
                    // –°—Ç–∏–ª–∏ –¥–ª—è —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞
                    if (tags.amenity || tags.shop || tags.tourism || tags.leisure) {
                        return poiStyle;
                    }
                    
                    // –°—Ç–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ç–æ—á–µ–∫
                    return new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 2,
                            fill: new ol.style.Fill({color: '#555'}),
                        }),
                        zIndex: 120
                    });
                },
                name: 'osm_point_tiles',
                className: 'osm-layer'
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–∏ –Ω–∞ –∫–∞—Ä—Ç—É –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
            map.addLayer(polygonLayer); // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª–∏–≥–æ–Ω—ã (—Ñ–æ–Ω)
            map.addLayer(lineLayer);    // –ó–∞—Ç–µ–º –ª–∏–Ω–∏–∏ (–¥–æ—Ä–æ–≥–∏, –∂–µ–ª–µ–∑–Ω—ã–µ –¥–æ—Ä–æ–≥–∏)
            map.addLayer(pointLayer);   // –ò –Ω–∞–∫–æ–Ω–µ—Ü —Ç–æ—á–∫–∏ (POI)
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
            osmVectorTileLayers = [polygonLayer, lineLayer, pointLayer];
            osmTilesVisible = true;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
            updateOSMOpacity();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ OSM —Å–ª–æ–µ–≤
        function updateOSMOpacity() {
            const opacity = document.getElementById('osm-opacity').value / 100;
            osmVectorTileLayers.forEach(layer => {
                layer.setOpacity(opacity);
            });
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö —Ç–∞–π–ª–æ–≤ OSM
        function removeOSMVectorTiles() {
            if (osmVectorTileLayers.length > 0) {
                osmVectorTileLayers.forEach(layer => {
                    map.removeLayer(layer);
                });
                osmVectorTileLayers = [];
            }
            osmTilesVisible = false;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function loadInitialData() {
            try {
                const points = {{ context|safe }};
                const features = new ol.format.GeoJSON().readFeatures(points, {
                    featureProjection: 'EPSG:3857'
                });
                vectorSource.addFeatures(features);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö
                lastDataSignature = calculateDataSignature(features);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', e);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö
        function calculateDataSignature(features) {
            if (features.length === 0) return 'empty';
            
            const coordsArray = features.map(feature => {
                const coords = feature.getGeometry().getCoordinates();
                return `${coords[0]},${coords[1]},${feature.get('f3') || 0}`;
            });
            
            return coordsArray.sort().join('|');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö
        async function checkDataChanges() {
            try {
                const response = await fetch('/geojson-data/');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                
                const data = await response.json();
                const features = new ol.format.GeoJSON().readFeatures(data, {
                    featureProjection: 'EPSG:3857'
                });
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–¥–ø–∏—Å—å
                const currentSignature = calculateDataSignature(features);
                
                // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –∏–∑–≤–µ—Å—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é
                if (currentSignature !== lastDataSignature) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –∫–∞—Ä—Ç–µ
                    vectorSource.clear();
                    vectorSource.addFeatures(features);
                    lastDataSignature = currentSignature;
                    console.log('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã. –ù–æ–≤—ã—Ö —Ç–æ—á–µ–∫:', features.length);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
                return false;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤—Å–µ–π –∫–∞—Ä—Ç—ã –≤ PNG
        function exportMapToBMP() {
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'export-loading';
            loadingIndicator.innerHTML = '–°–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è... <span></span>';
            document.body.appendChild(loadingIndicator);
            
            try {
                map.once('rendercomplete', function() {
                    const size = map.getSize();
                    const width = size[0];
                    const height = size[1];
                    
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    const ctx = tempCanvas.getContext('2d');
                    
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, width, height);
                    
                    const mapCanvases = document.querySelectorAll('.ol-viewport canvas');
                    
                    mapCanvases.forEach(canvas => {
                        if (canvas.width === 0 || canvas.height === 0) return;
                        
                        const transform = canvas.style.transform;
                        if (transform) {
                            const matrix = transform.match(/matrix\(([^)]+)\)/)[1].split(',').map(Number);
                            ctx.setTransform(matrix[0], matrix[1], matrix[2], matrix[3], matrix[4], matrix[5]);
                        }
                        
                        ctx.drawImage(canvas, 0, 0);
                        ctx.setTransform(1, 0, 0, 1, 0, 0);
                    });
                    
                    const dataURL = tempCanvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = dataURL;
                    link.download = `map_export_${new Date().toISOString().slice(0, 19).replace(/[-:T]/g, '')}.png`;
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        document.body.removeChild(loadingIndicator);
                    }, 100);
                });
                
                map.renderSync();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + error.message);
                document.body.removeChild(loadingIndicator);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö OSM
        function loadOSMData(bbox) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            if (!bbox || bbox.length !== 4) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç');
                return Promise.reject('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç');
            }
            
            for (let coord of bbox) {
                if (isNaN(coord) || coord === null || coord === undefined) {
                    alert('–û—à–∏–±–∫–∞: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –Ω–µ—á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è');
                    return Promise.reject('–ù–µ—á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç');
                }
            }
            
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'osm-loading';
            loadingIndicator.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö OSM... <span></span>';
            document.body.appendChild(loadingIndicator);
            
            return fetch('/load_osm/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ bbox: bbox })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ —Ç–∞–π–ª—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                    addOSMVectorTiles();
                    return data;
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + data.message);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ OSM:', error);
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                throw error;
            })
            .finally(() => {
                document.body.removeChild(loadingIndicator);
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function initControls() {
            const blurInput = document.getElementById('blur');
            const radiusInput = document.getElementById('radius');
            const osmOpacityInput = document.getElementById('osm-opacity');
            const blurValue = document.getElementById('blur-value');
            const radiusValue = document.getElementById('radius-value');
            const osmOpacityValue = document.getElementById('osm-opacity-value');
            const coordsElement = document.getElementById('mouse-coords');
            const toggleButton = document.getElementById('toggle-layers');
            const toggleOSMButton = document.getElementById('toggle-osm');
            const clearDbButton = document.getElementById('clear-db');
            const exportButton = document.getElementById('export-map');
            const drawOsmButton = document.getElementById('draw-osm-rect');
            const confirmDialog = document.getElementById('confirm-dialog');
            const confirmCancel = document.getElementById('confirm-cancel');
            const confirmOk = document.getElementById('confirm-ok');

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –º—ã—à–∏
            map.on('pointermove', (evt) => {
                if (evt.dragging) return;
                if (Date.now() - lastRenderTime < 100) return;
                lastRenderTime = Date.now();
                
                const coords = ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326');
                coordsElement.textContent = `${coords[0].toFixed(6)}, ${coords[1].toFixed(6)} (EPSG:4326)`;
                
                const feature = map.forEachFeatureAtPixel(evt.pixel, feature => feature, {
                    hitTolerance: 5,
                    layerFilter: layer => layer === pointLayer
                });

                if (feature) {
                    const value = feature.get('f3');
                    popup.show(evt.coordinate, `–ó–Ω–∞—á–µ–Ω–∏–µ: ${value}`);
                    map.getTargetElement().style.cursor = 'pointer';
                } else {
                    popup.hide();
                    map.getTargetElement().style.cursor = '';
                }
            });

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—è–º–∏
            toggleButton.addEventListener('click', () => {
                layersVisible = !layersVisible;
                pointLayer.setVisible(layersVisible);
                toggleButton.textContent = layersVisible ? '–°–∫—Ä—ã—Ç—å —Ç–æ—á–∫–∏' : '–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ—á–∫–∏';
            });

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ OSM —Ç–∞–π–ª–∞–º–∏
            toggleOSMButton.addEventListener('click', () => {
                if (osmTilesVisible) {
                    removeOSMVectorTiles();
                    toggleOSMButton.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å OSM';
                } else {
                    addOSMVectorTiles();
                    toggleOSMButton.textContent = '–°–∫—Ä—ã—Ç—å OSM';
                }
            });

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã
            blurInput.addEventListener('input', () => {
                heatmapLayer.setBlur(parseInt(blurInput.value));
                blurValue.textContent = blurInput.value;
            });

            radiusInput.addEventListener('input', () => {
                heatmapLayer.setRadius(parseInt(radiusInput.value));
                radiusValue.textContent = radiusInput.value;
            });
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é OSM
            osmOpacityInput.addEventListener('input', () => {
                updateOSMOpacity();
                osmOpacityValue.textContent = `${osmOpacityInput.value}%`;
            });

            // –≠–∫—Å–ø–æ—Ä—Ç –∫–∞—Ä—Ç—ã –≤ PNG
            exportButton.addEventListener('click', exportMapToBMP);

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            clearDbButton.addEventListener('click', function() {
                confirmDialog.style.display = 'flex';
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            confirmCancel.addEventListener('click', function() {
                confirmDialog.style.display = 'none';
            });
            
            confirmOk.addEventListener('click', function() {
                confirmDialog.style.display = 'none';
                
                // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
                fetch('/get-csrf-token/')
                .then(response => response.json())
                .then(data => {
                    const csrftoken = data.csrfToken;
                    
                    fetch('/clear-db/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            vectorSource.clear();
                            lastDataSignature = null;
                            removeOSMVectorTiles();
                            console.log('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞');
                        }
                    });
                });
            });
            
            window.addEventListener('click', function(event) {
                if (event.target === confirmDialog) {
                    confirmDialog.style.display = 'none';
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ OSM
            drawOsmButton.addEventListener('click', function() {
                osmVectorSource.clear();
                
                if (drawInteraction) {
                    map.removeInteraction(drawInteraction);
                }
                
                drawInteraction = new ol.interaction.Draw({
                    source: osmVectorSource,
                    type: 'Circle',
                    geometryFunction: ol.interaction.Draw.createBox()
                });
                
                map.addInteraction(drawInteraction);
                
                // –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                drawInteraction.on('drawend', function(event) {
                    const geometry = event.feature.getGeometry();
                    if (!geometry) {
                        alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—é');
                        return;
                    }
                    
                    const extent = geometry.getExtent();
                    if (!extent || extent.length !== 4) {
                        alert('–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å—Ç–µ–Ω—Ç–∞');
                        return;
                    }
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ WGS84
                    const minCoord = ol.proj.toLonLat([extent[0], extent[1]]);
                    const maxCoord = ol.proj.toLonLat([extent[2], extent[3]]);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    if (!minCoord || !maxCoord || 
                        isNaN(minCoord[0]) || isNaN(minCoord[1]) || 
                        isNaN(maxCoord[0]) || isNaN(maxCoord[1])) {
                        alert('–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±–ª–∞—Å—Ç–∏');
                        return;
                    }
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º bbox
                    const bbox = [
                        minCoord[0], 
                        minCoord[1], 
                        maxCoord[0], 
                        maxCoord[1]
                    ];
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
                    drawOsmButton.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
                    drawOsmButton.disabled = true;

                    // –£–¥–∞–ª—è–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                    map.removeInteraction(drawInteraction);
                    drawInteraction = null;
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ OSM
                    loadOSMData(bbox)
                        .then(() => {
                            drawOsmButton.innerHTML = 'üü© –í—ã–±—Ä–∞—Ç—å –æ–±–ª–∞—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ OSM';
                            drawOsmButton.disabled = false;
                        })
                        .catch(() => {
                            drawOsmButton.innerHTML = 'üü© –í—ã–±—Ä–∞—Ç—å –æ–±–ª–∞—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ OSM';
                            drawOsmButton.disabled = false;
                        });
                });
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
            blurValue.textContent = blurInput.value;
            radiusValue.textContent = radiusInput.value;
            osmOpacityValue.textContent = `${osmOpacityInput.value}%`;
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function startDataMonitoring() {
            eventSource = new EventSource('/data-updates/');
            
            eventSource.onmessage = async (event) => {
                try {
                    await checkDataChanges();
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e);
                }
            };
            
            eventSource.onerror = (error) => {
                console.error('–û—à–∏–±–∫–∞ SSE:', error);
                if (eventSource) eventSource.close();
                setTimeout(startDataMonitoring, 5000);
            };

            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            dataCheckInterval = setInterval(async () => {
                try {
                    await checkDataChanges();
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–∞–Ω–Ω—ã—Ö:', e);
                }
            }, 30000);
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function setupCleanup() {
            window.addEventListener('beforeunload', () => {
                if (eventSource) eventSource.close();
                if (dataCheckInterval) clearInterval(dataCheckInterval);
            });
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        function init() {
            initMap();
            loadInitialData();
            initControls();
            startDataMonitoring();
            setupCleanup();
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>